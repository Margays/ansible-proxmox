---
- name: Configure proxmox
  hosts: proxmox
  tasks:
    - name: Setup proxmox pool
      proxmox_pool:
        poolid: "test"
        comment: "Test pool"
        state: present

    - name: Configure cluster options
      proxmox_cluster_options:
        description: "Proxmox Casiopeia Cluster"

    - name: Create VM
      proxmox_node_qemu:
        node: "testprox"
        vmid: "101"
        name: "testvm"
        cores: 4
        memory: 4096
        tags: "test"
        pool: "test"
        net:
          - idx: 0
            model: virtio
            bridge: vmbr0
            tag: 101
          - idx: 1
            model: virtio
            bridge: vmbr0
            tag: 102
          - idx: 2
            model: virtio
            bridge: vmbr0
            tag: 103

        # Delete options
        destroy_unreferenced_disks: true
        state: present

    - name: Remove VM
      proxmox_node_qemu:
        node: "testprox"
        vmid: "102"
        state: absent
